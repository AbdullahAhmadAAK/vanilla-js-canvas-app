<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <canvas width="500" height="500" id="canvas" style="border: 1px solid black"></canvas>

  <label for="">Enable Drawing Mode</label>
  <input type="checkbox" onchange="togglerDrawingMode()">

  <script>
    let isDrawingMode = false

    function togglerDrawingMode() {
      isDrawingMode = !isDrawingMode
    }

    const canvas = document.getElementById('canvas')
    const ctx = canvas.getContext('2d')
    let penColor = 'red'
    let penWidth = 5

    const viewportTransform = {
      x: 0,
      y: 0,
      scale: 1
    }

    // From here on, everything we'll write will go below ðŸ‘‡
    const drawRect = (x, y, width, height, color) => {
      const { x: transformedX, y: transformedY } = ctx.transformedPoint(x, y)

      ctx.fillStyle = color
      ctx.fillRect(transformedX, transformedY, width, height)
    }

    const render = (e) => {

      // New code ðŸ‘‡
      ctx.setTransform(1, 0, 0, 1, 0, 0);

      if (isDrawingMode) {
        ctx.setTransform(viewportTransform.scale, 0, 0, viewportTransform.scale, viewportTransform.x, viewportTransform.y);
        const x = e.offsetX
        const y = e.offsetY

        drawPixels(x, y)
      } else {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.setTransform(viewportTransform.scale, 0, 0, viewportTransform.scale, viewportTransform.x, viewportTransform.y);
      }

      
      // ctx.setTransform(viewportTransform.scale, 0, 0, viewportTransform.scale, viewportTransform.x, viewportTransform.y);
      // New Code ðŸ‘†

      drawRect(0, 0, 100, 100, 'red');
      drawRect(200, 200, 100, 100, 'blue');
    }

    render()


    // We need to keep track of our previous mouse position for later
    let previousX = 0, previousY = 0;

    const updatePanning = (e) => {
      const localX = e.clientX;
      const localY = e.clientY;

      viewportTransform.x += localX - previousX;
      viewportTransform.y += localY - previousY;

      previousX = localX;
      previousY = localY;

      console.log('This is viewportTransform after updatePanning: ', viewportTransform)
    }

    const updateZooming = (e) => {
      const oldScale = viewportTransform.scale;
      const oldX = viewportTransform.x;
      const oldY = viewportTransform.y;

      if (viewportTransform.scale + (e.deltaY * -0.01) > 0) {
        const localX = e.clientX;
        const localY = e.clientY;

        const previousScale = viewportTransform.scale;

        const newScale = viewportTransform.scale += e.deltaY * -0.01;

        const newX = localX - (localX - oldX) * (newScale / previousScale);
        const newY = localY - (localY - oldY) * (newScale / previousScale);

        viewportTransform.x = newX;
        viewportTransform.y = newY;
        viewportTransform.scale = newScale;

        console.log('This is viewportTransform after updateZooming: ', viewportTransform)
      }
    }


    const onMouseMove = (e) => {

      if (isDrawingMode) {
        // const x = e.offsetX
        // const y = e.offsetY

        // console.log('these are x and y: ', x, y)

        // drawPixels(x, y)

        // dont pan at all in drawing mode, just draw
        render(e)
      } else {
        updatePanning(e)
        render(e)
      }

      
      // console.log(e)
    }

    const onMouseWheel = (e) => {
      if (isDrawingMode) {
        // dont zoom at all in drawing mode
      } else {
        updateZooming(e)
        render(e)
      }
      // console.log(e)
    }

    const drawPixels = (x, y) => {
      ctx.beginPath()

      ctx.arc(x, y, penWidth, 2 * Math.PI, false)
      ctx.fillStyle = penColor

      ctx.fill()
    }


    canvas.addEventListener("wheel", onMouseWheel);

    canvas.addEventListener("mousedown", (e) => {
      previousX = e.clientX;
      previousY = e.clientY;

      canvas.addEventListener("mousemove", onMouseMove);
    })

    canvas.addEventListener("mouseup", (e) => {
      canvas.removeEventListener("mousemove", onMouseMove);
    })


  </script>
</body>

</html>